<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Play ¬∑ Cyber Mystery Lunch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/app.css" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <h2 id="title">Game</h2>
    <div class="card">
      <div id="prompt" class="center">Waiting for host‚Ä¶</div>
      <div id="choices"></div>
    </div>
    <div class="card">
      <div id="status" class="small">‚Äî</div>
    </div>
  </div>
  <script>
    const code = new URL(location.href).searchParams.get('code') || localStorage.getItem('code') || 'demo';
    const playerId = localStorage.getItem('playerId');
  
    let lastRoundId = null;
  
    function setStatus(msg) {
      document.getElementById('status').textContent = msg || '‚Äî';
    }
  
    function showEnd(results) {
      const container = document.querySelector('.container');
      const players = (results.players || []).sort((a, b) => b.score - a.score);
      const top = players[0];
      document.getElementById('prompt').textContent = 'Game Over';
      document.getElementById('choices').innerHTML = players
        .map((p, i) => `<div class="choice">${i === 0 ? 'üèÜ ' : ''}${p.name} ‚Äî <b>${p.score}</b></div>`)
        .join('');
      setStatus(top ? `Winner: ${top.name} (${top.score})` : 'No players');
      // action buttons
      const actions = document.createElement('div');
      actions.className = 'row';
      actions.innerHTML = `
        <button class="btn" id="homeBtn">Back to Home</button>
        <button class="btn" id="joinBtn">Join Another Game</button>
      `;
      document.querySelector('.container').appendChild(actions);
      document.getElementById('homeBtn').onclick = () => (location.href = '/');
      document.getElementById('joinBtn').onclick = () => (location.href = '/index.html');
    }
  
    async function refresh() {
      const cur = await (await fetch(`/api/current?code=${code}`)).json();
  
      if (cur.phase === 'results') {
        const s = await (await fetch(`/api/scoreboard?code=${code}`)).json();
        showEnd(s);
        return;
      }
  
      if (!cur.round) {
        document.getElementById('prompt').textContent = cur.phase === 'lobby' ? 'Waiting for host‚Ä¶' : 'Loading‚Ä¶';
        document.getElementById('choices').innerHTML = '';
        return;
      }
  
      // If round changed, clear any prior ‚ÄúCorrect/Not quite‚Äù
      if (cur.round.id !== lastRoundId) {
        lastRoundId = cur.round.id;
        setStatus('‚Äî');
      }
  
      document.getElementById('prompt').textContent = cur.round.prompt;
      document.getElementById('choices').innerHTML = cur.round.choices
        .map(c => `<div class="choice" data-id="${c.id}">${c.id}. ${c.text}</div>`)
        .join('');
  
      document.querySelectorAll('.choice').forEach(el => {
        el.onclick = async () => {
          const choiceId = el.getAttribute('data-id');
          const r = await (await fetch(`/api/answer?code=${code}`, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ playerId, choiceId })
          })).json();
          setStatus(r.already ? 'Already answered' : (r.correct ? '‚úÖ Correct!' : '‚ùå Not quite'));
        };
      });
    }
  
    setInterval(refresh, 1200);
    refresh();
  </script>
 
</body>
</html>
